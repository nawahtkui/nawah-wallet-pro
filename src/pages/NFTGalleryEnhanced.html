<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø¹Ø±Ø¶ NFTs - Nawah Wallet Enhanced</title>
<link rel="stylesheet" href="../styles/nft_gallery.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.min.js"></script>
<style>
  /* Ø¨Ø³ÙŠØ· CSS Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø´Ø¨ÙƒØ© */
  body { background:#121212; color:#fff; font-family: sans-serif; margin:0; padding:0;}
  #grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:1rem; padding:1rem;}
  .card { background:#1e1e1e; border-radius:8px; overflow:hidden; padding:0.5rem;}
  .thumb { width:100%; border-radius:6px;}
  .meta { padding:0.5rem;}
  .badge { display:inline-block; padding:2px 6px; border-radius:4px; margin-bottom:4px; font-size:0.8rem;}
  .legendary { background:gold; color:#000;}
  .rare { background:purple; color:#fff;}
  .common { background:gray; color:#fff;}
  .actions { display:flex; gap:0.5rem; margin-top:4px;}
  button.action-btn { flex:1; padding:4px; cursor:pointer; border:none; border-radius:4px;}
</style>
</head>
<body>

<h1 style="text-align:center;">ğŸ›ï¸ Ù…ØªØ­Ù Ù†ÙˆØ§Ø© â€” Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ultimate</h1>

<div style="text-align:center; margin-bottom:1rem;">
  <button id="connectBtn">ğŸ”Œ Connect (Mock)</button>
  <button id="realConnectBtn" style="display:none;">ğŸŸ¢ Connect Wallet</button>
  <span id="walletInfo"></span>
</div>

<div style="text-align:center; margin-bottom:1rem;">
  <input type="text" id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…">
  <select id="rarity">
    <option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±</option>
    <option value="legendary">Legendary</option>
    <option value="rare">Rare / Ù…Ù…ÙŠØ²</option>
    <option value="common">Common</option>
  </select>
  <select id="sort">
    <option value="id">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø±Ù‚Ù…</option>
    <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
    <option value="rarity">Ø§Ù„Ù†Ø¯Ø±Ø©</option>
  </select>
  <button id="refresh">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
</div>

<div id="grid"></div>

<!-- Lightbox -->
<div id="lightbox" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); align-items:center; justify-content:center;">
  <img id="lbimg" style="max-width:90%; max-height:90%; border-radius:8px;">
</div>

<script type="module">
// ------------------- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -------------------
import nftData from "../nft_data/nft_frontend.json" assert { type: "json" };

const grid = document.getElementById("grid");
const walletInfo = document.getElementById("walletInfo");
const connectBtn = document.getElementById("connectBtn");
const realConnectBtn = document.getElementById("realConnectBtn");
const refreshBtn = document.getElementById("refresh");
const searchInput = document.getElementById("search");
const raritySelect = document.getElementById("rarity");
const sortSelect = document.getElementById("sort");
const lightbox = document.getElementById("lightbox");
const lbimg = document.getElementById("lbimg");

let provider = null;
let signer = null;
let contract = null;
let userAddress = null;
let userNFTs = [];

// Ø¶Ø¹ Ù‡Ù†Ø§ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ BSCTestnet
const CONTRACT_ADDRESS = "Ø¶Ø¹_Ø§Ù„Ø¹Ù†ÙˆØ§Ù†_Ù‡Ù†Ø§";

// ------------------- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© -------------------
function rarityClass(r){
  if(!r) return "common";
  r = r.toLowerCase();
  if(r.includes("legend")) return "legendary";
  if(r.includes("epic") || r.includes("Ù…Ù…ÙŠØ²") || r.includes("rare")) return "rare";
  return "common";
}

function render(cards){
  grid.innerHTML = "";
  if(!cards || cards.length===0){
    grid.innerHTML = "<div style='padding:20px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>";
    return;
  }
  for(const nft of cards){
    const idVal = nft.tokenId !== undefined ? String(nft.tokenId) : (nft.id || "â€”");
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <img class="thumb" src="${nft.image}" alt="${nft.name}">
      <div class="meta">
        <h3>${nft.name}</h3>
        <p>${nft.description || ""}</p>
        <div class="badge ${rarityClass(nft.rarity)}">${nft.rarity||"Common"}</div>
        <div class="small">#${idVal}</div>
        <div class="actions">
          <button class="action-btn view" data-img="${nft.image}">Ø¹Ø±Ø¶</button>
          <button class="action-btn transfer" data-id="${idVal}" ${!userAddress?"disabled":""}>Ù†Ù‚Ù„</button>
        </div>
      </div>
    `;
    el.querySelector(".view").addEventListener("click",()=>{ lbimg.src=nft.image; lightbox.style.display="flex"; });
    el.querySelector(".transfer").addEventListener("click", async ()=>{
      if(!userAddress){ alert("ğŸ”’ ÙŠØ±Ø¬Ù‰ ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£ÙˆÙ„Ø§"); return; }
      const to = prompt("Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù…:");
      if(!to) return;
      try {
        let tx;
        if(contract["safeTransferFrom(address,address,uint256)"])
          tx = await contract["safeTransferFrom(address,address,uint256)"](userAddress, to, BigInt(nft.tokenId));
        else
          tx = await contract.safeTransferFrom(userAddress, to, BigInt(nft.tokenId));
        alert("ğŸ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©...");
        await tx.wait();
        alert("âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„!");
        await loadNFTsFromChain();
      } catch(e){ console.error(e); alert("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: "+e.message); }
    });
    grid.appendChild(el);
  }
}

async function loadNFTsFromChain(){
  if(!contract) return render(nftData);
  grid.innerHTML = "â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ NFTs Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©...";
  userNFTs = [];
  const balanceBN = await contract.balanceOf(userAddress);
  const balance = Number(balanceBN.toString());
  for(let i=0;i<balance;i++){
    const tokenIdBN = await contract.tokenOfOwnerByIndex(userAddress,i);
    const tokenId = tokenIdBN.toString();
    let tokenURI = await contract.tokenURI(tokenId);
    if(tokenURI.startsWith("ipfs://")) tokenURI = tokenURI.replace("ipfs://","https://ipfs.io/ipfs/");
    try{
      const metaResp = await fetch(tokenURI);
      const meta = await metaResp.json();
      const image = meta.image?.startsWith("ipfs://") ? meta.image.replace("ipfs://","https://ipfs.io/ipfs/") : meta.image || "";
      userNFTs.push({ tokenId, id: tokenId, name:meta.name||`NFT #${tokenId}`, description:meta.description||"", image, rarity:meta.rarity||"" });
    } catch(e){
      userNFTs.push({ tokenId, id: tokenId, name:`NFT #${tokenId}`, description:tokenURI, image:"" });
    }
  }
  render(userNFTs);
}

// ------------------- Events -------------------
connectBtn.addEventListener("click", ()=>{
  userAddress = "0xDEADBEEF1234...";
  walletInfo.innerText="âœ… Ù…ØªØµÙ„ (Mock): "+userAddress;
  connectBtn.style.display="none";
  realConnectBtn.style.display="inline-block";
  userNFTs = nftData.map(x=>({...x,tokenId:x.id}));
  render(userNFTs);
});

realConnectBtn.addEventListener("click", async ()=>{
  if(!window.ethereum){ alert("ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª MetaMask"); return; }
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();
  walletInfo.innerText=`âœ… Ù…ØªØµÙ„: ${userAddress}`;
  const ABI = await (await fetch("../nft_data/NawahNFT_ABI.json")).json();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  await loadNFTsFromChain();
  connectBtn.style.display="none";
  realConnectBtn.style.display="none";
});

refreshBtn.addEventListener("click", ()=>{ loadNFTsFromChain(); });
[searchInput, raritySelect, sortSelect].forEach(el=>el.addEventListener("input",()=>{
  let list = userNFTs.length>0?userNFTs.slice():nftData.slice();
  const q=searchInput.value.trim().toLowerCase();
  const r=raritySelect.value;
  const s=sortSelect.value;
  if(q) list = list.filter(x=>(x.name||"").toLowerCase().includes(q) || (""+(x.id||x.tokenId||"")).includes(q));
  if(r) list = list.filter(x=>(x.rarity||"").toLowerCase()===r.toLowerCase());
  if(s==="rarity") { const order=["legendary","epic","rare","common"]; list.sort((a,b)=> order.indexOf((a.rarity||"common").toLowerCase())-order.indexOf((b.rarity||"common").toLowerCase())); }
  else if(s==="name") list.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  else if(s==="id") list.sort((a,b)=>(Number(a.id||a.tokenId||0)-Number(b.id||b.tokenId||0)));
  render(list);
}));

lightbox.addEventListener("click", ()=>{ lightbox.style.display="none"; lbimg.src=""; });

// ------------------- Initial render -------------------
render(nftData);

</script>
</body>
</html>
